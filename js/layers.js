// –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–ª–æ–µ–≤
class LayersManager {
    constructor(app) {
        this.app = app;
        this.layersList = document.getElementById('layers-list');

        this.init();
    }

    init() {
        this.setupEventListeners();
    }

    setupEventListeners() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–ª–æ–µ–≤
    }

    update(elements, selectedElement) {
        this.layersList.innerHTML = '';

        // –°–æ–∑–¥–∞–µ–º —Å–ª–æ–∏ –≤ –æ–±—Ä–∞—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ (–ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–π —Å–≤–µ—Ä—Ö—É)
        const sortedElements = [...elements].reverse();

        sortedElements.forEach((element, index) => {
            this.createLayerItem(element, elements.length - 1 - index, selectedElement);
        });
    }

    createLayerItem(element, index, selectedElement) {
        const layerItem = document.createElement('div');
        layerItem.className = 'layer-item';
        layerItem.id = `layer-${element.id}`;

        if (selectedElement && selectedElement.id === element.id) {
            layerItem.classList.add('selected');
        }

        const layerHeader = document.createElement('div');
        layerHeader.className = 'layer-header';

        const layerType = document.createElement('span');
        layerType.className = 'layer-type';
        layerType.textContent = element.type === 'text' ? '–¢–µ–∫—Å—Ç' : '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';

        const layerControls = document.createElement('div');
        layerControls.className = 'layer-controls';

        // –ö–Ω–æ–ø–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏
        const visibilityBtn = document.createElement('button');
        visibilityBtn.className = 'layer-control';
        visibilityBtn.innerHTML = 'üëÅ';
        visibilityBtn.title = '–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å';
        visibilityBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleVisibility(element);
        });

        // –ö–Ω–æ–ø–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        const lockBtn = document.createElement('button');
        lockBtn.className = 'layer-control';
        lockBtn.innerHTML = 'üîì';
        lockBtn.title = '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';
        lockBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleLock(element);
        });

        // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'layer-control';
        deleteBtn.innerHTML = 'üóë';
        deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å —Å–ª–æ–π';
        deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.deleteLayer(element);
        });

        layerControls.appendChild(visibilityBtn);
        layerControls.appendChild(lockBtn);
        layerControls.appendChild(deleteBtn);

        layerHeader.appendChild(layerType);
        layerHeader.appendChild(layerControls);

        const layerName = document.createElement('div');
        layerName.className = 'layer-name';
        layerName.textContent = this.getLayerName(element);

        const layerInfo = document.createElement('div');
        layerInfo.className = 'layer-info';
        layerInfo.textContent = `${this.formatTime(element.startTime)} - ${this.formatTime(element.startTime + (element.duration || 5))}`;

        layerItem.appendChild(layerHeader);
        layerItem.appendChild(layerName);
        layerItem.appendChild(layerInfo);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Å–ª–æ—è
        layerItem.addEventListener('click', () => {
            this.selectLayer(element);
        });

        // –î–µ–ª–∞–µ–º —Å–ª–æ–π –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–º –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞
        this.makeLayerDraggable(layerItem, element, index);

        this.layersList.appendChild(layerItem);
    }

    getLayerName(element) {
        if (element.type === 'text') {
            return element.content.length > 20 ?
                element.content.substring(0, 20) + '...' :
                element.content;
        } else if (element.type === 'image') {
            return `–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ${element.id}`;
        }
        return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–ª–æ–π';
    }

    selectLayer(element) {
        // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö —Å–ª–æ–µ–≤
        const layers = this.layersList.querySelectorAll('.layer-item');
        layers.forEach(layer => layer.classList.remove('selected'));

        // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Å–ª–æ–π
        const layerItem = document.getElementById(`layer-${element.id}`);
        if (layerItem) {
            layerItem.classList.add('selected');
        }

        // –í—ã–¥–µ–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
        if (this.app.elementManager) {
            this.app.elementManager.selectElement(element);
            this.app.updateProperties();
        }
    }

    toggleVisibility(element) {
        element.visible = element.visible !== false ? false : true;

        const el = document.getElementById(`element-${element.id}`);
        if (el) {
            el.style.display = element.visible === false ? 'none' : 'block';
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É
        const layerItem = document.getElementById(`layer-${element.id}`);
        const visibilityBtn = layerItem.querySelector('.layer-control');
        visibilityBtn.innerHTML = element.visible === false ? 'üëÅ‚Äçüó®' : 'üëÅ';

        if (element.visible === false) {
            layerItem.style.opacity = '0.5';
        } else {
            layerItem.style.opacity = '1';
        }
    }

    toggleLock(element) {
        element.locked = !element.locked;

        const el = document.getElementById(`element-${element.id}`);
        if (el) {
            el.style.pointerEvents = element.locked ? 'none' : 'auto';
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É
        const layerItem = document.getElementById(`layer-${element.id}`);
        const lockBtn = layerItem.querySelectorAll('.layer-control')[1];
        lockBtn.innerHTML = element.locked ? 'üîí' : 'üîì';

        if (element.locked) {
            layerItem.style.opacity = '0.7';
        } else {
            layerItem.style.opacity = '1';
        }
    }

    deleteLayer(element) {
        if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å–ª–æ–π?')) {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–ª–∞–π–¥ –∏ —É–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ –Ω–µ–≥–æ
            const slide = this.app.slideManager.getCurrentSlide();
            if (slide && slide.elements) {
                const index = slide.elements.findIndex(el => el.id === element.id);
                if (index !== -1) {
                    slide.elements.splice(index, 1);
                }
            }

            // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM
            const el = document.getElementById(`element-${element.id}`);
            if (el) {
                el.remove();
            }

            // –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º—ã–π —ç–ª–µ–º–µ–Ω—Ç –±—ã–ª –≤—ã–¥–µ–ª–µ–Ω, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
            if (this.app.elementManager.getSelectedElement() && this.app.elementManager.getSelectedElement().id === element.id) {
                this.app.elementManager.selectElement(null);
                this.app.updateProperties();
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            const currentSlide = this.app.slideManager.getCurrentSlide();
            const elements = currentSlide ? currentSlide.elements : [];
            this.update(elements, this.app.elementManager.getSelectedElement());
            this.app.updateTimeline();
        }
    }

    makeLayerDraggable(layerItem, element, index) {
        let isDragging = false;
        let dragStartY = 0;
        let dragStartIndex = index;

        layerItem.addEventListener('mousedown', (e) => {
            // –ù–µ –Ω–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ –∫–Ω–æ–ø–∫–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            if (e.target.classList.contains('layer-control')) {
                return;
            }

            isDragging = true;
            dragStartY = e.clientY;
            dragStartIndex = index;

            layerItem.style.opacity = '0.7';
            layerItem.style.transform = 'scale(1.02)';

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        });

        const onMouseMove = (e) => {
            if (!isDragging) return;

            const deltaY = e.clientY - dragStartY;
            const itemHeight = layerItem.offsetHeight + 8; // –≤—ã—Å–æ—Ç–∞ + gap
            const slide = this.app.slideManager.getCurrentSlide();
            const elements = slide ? slide.elements : [];
            const newIndex = Math.max(0, Math.min(
                elements.length - 1,
                dragStartIndex + Math.round(deltaY / itemHeight)
            ));

            if (newIndex !== index) {
                this.reorderLayer(element, dragStartIndex, newIndex);
                dragStartIndex = newIndex;
                dragStartY = e.clientY;
            }
        };

        const onMouseUp = () => {
            isDragging = false;
            layerItem.style.opacity = '1';
            layerItem.style.transform = 'scale(1)';

            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };
    }

    reorderLayer(element, fromIndex, toIndex) {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–ª–∞–π–¥
        const slide = this.app.slideManager.getCurrentSlide();
        if (!slide || !slide.elements) return;

        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ –º–∞—Å—Å–∏–≤–µ
        const actualFromIndex = slide.elements.length - 1 - fromIndex;
        const actualToIndex = slide.elements.length - 1 - toIndex;

        const [movedElement] = slide.elements.splice(actualFromIndex, 1);
        slide.elements.splice(actualToIndex, 0, movedElement);

        // –û–±–Ω–æ–≤–ª—è–µ–º z-index —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        this.updateZIndices();

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        this.update(slide.elements, this.app.elementManager.getSelectedElement());
    }

    updateZIndices() {
        const slide = this.app.slideManager.getCurrentSlide();
        const elements = slide ? slide.elements : [];
        elements.forEach((element, index) => {
            const el = document.getElementById(`element-${element.id}`);
            if (el) {
                el.style.zIndex = index + 1;
            }
        });
    }

    duplicateLayer(element) {
        const newElement = {
            ...element,
            id: Date.now(),
            x: element.x + 20,
            y: element.y + 20,
            startTime: element.startTime + 0.5
        };

        this.app.elements.push(newElement);
        this.app.renderElement(newElement);
        this.app.selectElement(newElement);
        this.update(this.app.elements, newElement);
        this.app.updateTimeline();
    }

    groupLayers(elements) {
        // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–ª–æ–µ–≤ (–¥–ª—è –±—É–¥—É—â–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è)
        const group = {
            id: Date.now(),
            type: 'group',
            name: '–ì—Ä—É–ø–ø–∞',
            elements: elements,
            visible: true,
            locked: false
        };

        // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞
        elements.forEach(element => {
            const index = this.app.elements.findIndex(el => el.id === element.id);
            if (index !== -1) {
                this.app.elements.splice(index, 1);
            }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä—É–ø–ø—É
        this.app.elements.push(group);

        this.update(this.app.elements, this.app.selectedElement);
    }

    ungroupLayers(group) {
        // –†–∞–∑–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–ª–æ–µ–≤
        if (group.type !== 'group') return;

        const index = this.app.elements.findIndex(el => el.id === group.id);
        if (index !== -1) {
            this.app.elements.splice(index, 1);
            this.app.elements.push(...group.elements);
        }

        this.update(this.app.elements, this.app.selectedElement);
    }
    
    formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Å–ª–æ–µ–≤
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        if (window.app) {
            window.layersManager = new LayersManager(window.app);
        }
    }, 100);
});